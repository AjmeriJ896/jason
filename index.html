<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Islamic Calendar with Server Sync</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .input-section, .result-section, .moon-section {
            margin: 20px 0;
        }
        input {
            padding: 8px;
            margin: 5px;
        }
        button {
            padding: 8px 15px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #219653;
        }
        #moonPhase, #hijriResult, #currentHijri {
            font-size: 1.2em;
            margin-top: 10px;
            color: #34495e;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Islamic Calendar & Moon Phase (Server Synced)</h1>

        <!-- Birthdate Input Section -->
        <div class="input-section">
            <h3>Find Your Hijri Birthdate</h3>
            <label>Enter your birthdate (Gregorian):</label><br>
            <input type="date" id="gregorianDate"><br>
            <button onclick="convertToHijri()">Convert to Hijri</button>
        </div>

        <!-- Result Section -->
        <div class="result-section">
            <h3>Your Hijri Birthdate:</h3>
            <p id="hijriResult">Enter a date to see the Hijri equivalent</p>
        </div>

        <!-- Current Hijri Date & Moon Phase -->
        <div class="moon-section">
            <h3>Today in Islamic Calendar</h3>
            <p id="currentHijri">Loading...</p>
            <h3>Moon Phase Today</h3>
            <p id="moonPhase">Loading...</p>
        </div>
    </div>

    <script>
        // Function to fetch Hijri date from Aladhan API
        async function fetchHijriDate(gregorianDate) {
            const [year, month, day] = gregorianDate.split('-');
            const url = `http://api.aladhan.com/v1/gToH?date=${day}-${month}-${year}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.code === 200) {
                    const hijri = data.data.hijri;
                    return `${hijri.day} ${hijri.month.en} ${hijri.year} AH`;
                } else {
                    throw new Error('API Error');
                }
            } catch (error) {
                consoleážŸthrow new Error(`Failed to fetch Hijri date: ${error.message}`);
            }
        }

        // Enhanced Convert to Hijri function with server sync
        async function convertToHijri() {
            const gregorianInput = document.getElementById('gregorianDate').value;
            const resultElement = document.getElementById('hijriResult');

            // Input validation
            if (!gregorianInput) {
                resultElement.innerHTML = '<span class="error">Please select a valid date!</span>';
                return;
            }

            const gregorianDate = new Date(gregorianInput);
            const today = new Date();

            if (isNaN(gregorianDate.getTime())) {
                resultElement.innerHTML = '<span class="error">Invalid date format!</span>';
                return;
            } else if (gregorianDate > today) {
                resultElement.innerHTML = '<span class="error">Future dates are not allowed!</span>';
                return;
            }

            try {
                const hijriString = await fetchHijriDate(gregorianInput);
                resultElement.innerHTML = hijriString;
            } catch (error) {
                resultElement.innerHTML = `<span class="error">${error.message}</span>`;
            }
        }

        // Function to update current Hijri date from server
        async function updateCurrentHijri() {
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
            try {
                const hijriString = await fetchHijriDate(today);
                document.getElementById('currentHijri').innerText = hijriString;
            } catch (error) {
                document.getElementById('currentHijri').innerText = `Error: ${error.message}`;
            }
        }

        // Function to calculate moon phase (simplified, local)
        function getMoonPhase() {
            const today = new Date();
            const epoch = new Date('1970-01-01');
            const daysSinceEpoch = Math.floor((today - epoch) / (1000 * 60 * 60 * 24));
            const lunarCycle = 29.53; // Average lunar cycle in days
            const phase = daysSinceEpoch % lunarCycle;

            let phaseName;
            if (phase < 1.84566) phaseName = "New Moon ðŸŒ‘";
            else if (phase < 5.53699) phaseName = "Waxing Crescent ðŸŒ’";
            else if (phase < 9.22831) phaseName = "First Quarter ðŸŒ“";
            else if (phase < 12.91963) phaseName = "Waxing Gibbous ðŸŒ”";
            else if (phase < 16.61096) phaseName = "Full Moon ðŸŒ•";
            else if (phase < 20.30228) phaseName = "Waning Gibbous ðŸŒ–";
            else if (phase < 23.99361) phaseName = "Last Quarter ðŸŒ—";
            else if (phase < 27.68493) phaseName = "Waning Crescent ðŸŒ˜";
            else phaseName = "New Moon ðŸŒ‘";

            document.getElementById('moonPhase').innerText = phaseName;
        }

        // Update on page load and daily
        window.onload = function() {
            updateCurrentHijri();
            getMoonPhase();
            setInterval(() => {
                updateCurrentHijri();
                getMoonPhase();
            }, 24 * 60 * 60 * 1000); // Update every 24 hours
        };
    </script>
</body>
</html>